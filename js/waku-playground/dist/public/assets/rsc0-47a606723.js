import{r as t}from"./index-ZTOZCyuL.js";import{Root as y,useRefetch as M,prefetchRSC as x,Slot as I}from"./waku-client.js";import"./index-ygKPTG2k.js";function C(e){const o=e.split("/").filter(Boolean),a=new Set;for(let i=0;i<=o.length;++i){const l=[...o.slice(0,i),"layout"].join("/");a.add(l)}return a.add([...o,"page"].join("/")),Array.from(a)}function _(e){if(!e.startsWith("/"))throw new Error("Path should start with `/`");return e.slice(1)}const R="waku_router_skip",b="/SHOULD_SKIP",P=()=>{const{pathname:e,search:o}=window.location,a=new URLSearchParams(o);return a.has(R)&&console.warn(`The search param "${R}" is reserved`),{path:e,searchParams:a}},k=t.createContext(null);function j(){const e=t.useContext(k);return e?e.changeLocation:()=>{throw new Error("Missing Router")}}function D(){const e=t.useContext(k);if(!e)throw new Error("Missing Router");return e.loc}function F({to:e,children:o,pending:a,notPending:i,unstable_prefetchOnEnter:l,...c}){if(!e.startsWith("/"))throw new Error('Link must start with "/"');const u=t.useContext(k),m=u?u.changeLocation:()=>{throw new Error("Missing Router")},w=u?u.prefetchLocation:()=>{throw new Error("Missing Router")},[d,r]=t.useTransition(),s=h=>{var f;h.preventDefault();const n=new URL(e,window.location.href);n.href!==window.location.href&&(w(n.pathname,n.searchParams),r(()=>{m(n.pathname,n.searchParams)})),(f=c.onClick)==null||f.call(c,h)},E=l?h=>{var f;const n=new URL(e,window.location.href);n.href!==window.location.href&&w(n.pathname,n.searchParams),(f=c.onMouseEnter)==null||f.call(c,h)}:c.onMouseEnter,p=t.createElement("a",{...c,href:e,onClick:s,onMouseEnter:E},o);return d&&a!==void 0?t.createElement(t.Fragment,null,p,a):!d&&i!==void 0?t.createElement(t.Fragment,null,p,i):p}const U=(e,o,a)=>{const i=document.querySelector('meta[name="waku-should-skip"]');if(!i)return[];const l=JSON.parse(i.content);return e.filter(c=>{var w;const u=a[c];if(!u)return!1;const m=l==null?void 0:l[c];return!(!m||m.path&&o.path!==u.path||(w=m.keys)!=null&&w.some(d=>o.searchParams.get(d)!==u.searchParams.get(d)))})};function A(){const e=M(),[o,a]=t.useState(P),i=C(o.path),[l,c]=t.useState(()=>Object.fromEntries(i.map(r=>[r,o]))),u=t.useRef(l);t.useEffect(()=>{u.current=l},[l]);const m=t.useCallback((r,s,E="pushState",p={top:0,left:0})=>{const h=new URL(window.location.href);r&&(h.pathname=r),s&&(h.search="?"+s.toString()),E&&window.history[E](window.history.state,"",h);const n=P();a(n),p&&window.scrollTo(p);const f=C(n.path),g=U(f,n,u.current);if(f.every(S=>g.includes(S)))return;const L=_(n.path);e(L,new URLSearchParams([...Array.from(n.searchParams.entries()),...g.map(S=>[R,S])])),c(S=>({...S,...Object.fromEntries(f.flatMap(v=>g.includes(v)?[]:[[v,n]]))}))},[e]),w=t.useCallback((r,s)=>{var g;const E=C(r),h=U(E,{path:r,searchParams:s},u.current);if(E.every(L=>h.includes(L)))return;const n=_(r),f=new URLSearchParams([...Array.from(s.entries()),...h.map(L=>[R,L])]).toString();x(n,f),(g=globalThis.__WAKU_ROUTER_PREFETCH__)==null||g.call(globalThis,r)},[]);t.useEffect(()=>{const r=()=>{const s=P();w(s.path,s.searchParams),m(s.path,s.searchParams,!1)};return window.addEventListener("popstate",r),()=>window.removeEventListener("popstate",r)},[m,w]);const d=i.reduceRight((r,s)=>t.createElement(I,{id:s,fallback:r},r),null);return t.createElement(t.Fragment,null,t.createElement(I,{id:b}),t.createElement(k.Provider,{value:{loc:o,changeLocation:m,prefetchLocation:w}},d))}function H(){const e=P(),o=_(e.path),a=e.searchParams.toString();return t.createElement(y,{initialInput:o,initialSearchParamsString:a},t.createElement(A))}export{F as Link,H as Router,j as useChangeLocation,D as useLocation};
